<html style="background-color: black">
  <head>
    <meta charset="utf-8">
    <title>14 Octavus, Irvine, CA</title>
    <meta name="description" content="Dev Example â€” Networked-Aframe">

    <script src="../js/vr_group_session.js"></script>   
    <!-- <script src="../js/aframe.min.js"></script>  -->
    <script src="https://aframe.io/releases/0.7.1/aframe.min.js"></script>
    <script>window.NAF || document.write('<script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js">\x3C/script>')</script>
    <script src="https://unpkg.com/networked-aframe@^0.6.0/dist/networked-aframe.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.2.0/dist/aframe-physics-system.min.js"></script>
    <!-- <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v6.0.0/dist/aframe-extras.min.js"></script> -->
    <script src='../js/kinematic-body.js'></script>
    <script src="../js/movement-controls.js"></script>
    <script src="../js/touch-controls.js"></script>
    <script src="../js/trackpad-controls.js"></script>
    <script src='../js/kinematic-body.js'></script>
    <script src="//unpkg.com/aframe-animation-component@4.1.2/dist/aframe-animation-component.min.js"></script>
    <script src="https://dist.3d.io/3dio-js/1.1.x/3dio.min.js"></script>
    <script src="../js/vus_movement.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^4.0.0/dist/aframe-event-set-component.min.js"></script>

    <script>
      AFRAME.registerComponent("forward_space", {
        init: function() {
          var camera = document.querySelector("a-camera")
          var player = document.querySelector("#player")
          window.addEventListener("keydown", (e) => {
            if (e.code === "Space") {
               var angle = camera.getAttribute("rotation")
               var x = .3 * Math.cos((angle.y-90) * Math.PI / 180)
               var y = .3 * Math.sin((angle.y-90) * Math.PI / 180)
               var pos = player.getAttribute("position")
               pos.x -= y;
               pos.z -= x;
               player.setAttribute("position", pos);
             }
           })
         }
        });

      AFRAME.registerComponent('bcn_teleport', {
        init: function () {
            this.el.addEventListener('click', function (evt) {
                transition();
                setTimeout(function(){
                    // teleport user to sphere on click [Check if VR device and make it work for that too]
                    if(isHeadset){
                        var pos = document.getElementById("player").getAttribute('position');

                        var pos_cam = document.querySelector("a-camera").getAttribute('position');
                        pos_cam.x = 0;
                        pos_cam.z = 0;
                        document.querySelector("a-camera").setAttribute('position', pos_cam);

                        coords_pics = getClosestImageCoords(posx,posz,photosHeadset);
                        pos.x = evt.detail.intersection.point.x
                        pos.z = evt.detail.intersection.point.z
                        document.getElementById("player").setAttribute('position',pos);
                    }
                    else{
                        var pos = document.querySelector("a-camera").getAttribute('position');
                        pos.x = evt.detail.intersection.point.x
                        pos.z = evt.detail.intersection.point.z
                        document.querySelector("a-camera").setAttribute('position',pos)
                    }
                },600)
            });
            this.el.addEventListener('mouseenter', function(evt){
                this.setAttribute("color","green");
            })
            this.el.addEventListener('mouseleave', function(evt){
                this.setAttribute("color", "lightblue");
            })
        }
      });

      // fixes the angle of the controller
      AFRAME.components['laser-controls'].Component.prototype.config['oculus-touch-controls'].raycaster.direction.y = 0;
        document.addEventListener("DOMContentLoaded", function () {
          document.querySelector("a-scene")
            .addEventListener("loaded", function fixModelPoses() {
              Array.from(document.querySelectorAll('[oculus-touch-controls]'))
                .filter(el => el.components['oculus-touch-controls'].controllerPresent)
                .forEach(el => {
                  el.addEventListener('model-loaded', () => {
                    // FIX TWO: align model with raycaster (and reality)
                    var mesh = el.getObject3D('mesh');
                    mesh.rotateX(Math.PI / 4);
                    mesh.translateY(0.06);
                  });
                });
          });
        });
    </script>


  </head>

  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <a-scene antialias="true" physics="gravity:0;"  networked-scene="
      room: dev;
      debug: true;
      adapter: wseasyrtc;
      connectOnLoad: false;
      audio: true;
    ">
      <a-assets>
        <img id="grid" src="https://img.gs/bbdkhfbzkk/stretch/https://i.imgur.com/25P1geh.png" crossorigin="anonymous">
      
        <img id="sky" src="assets/sky.jpg" />
        <img id="black" src="assets/black.jpg" />

        <!-- Templates -->

        <!-- Avatar -->
        <template id="player-template">
          <a-entity></a-entity>
        </template>

        <!-- Avatar -->
        <template id="head-template">
          <a-entity class="avatar">
            <!-- <a-gltf-model id="head4" src="../assets/head_4/model.gltf"></a-gltf-model> -->

            <a-asset-item id="raccoon-obj" src="assets/Raccoon_Blocks/model.obj"></a-asset-item>
            <a-asset-item id="raccoon-mtl" src="assets/Raccoon_Blocks/materials.mtl"></a-asset-item>

            <a-asset-item id="left-controller-obj" src="assets/controllers/left.obj"></a-asset-item>
            <a-asset-item id="left-controller-mtl" src="assets/controllers/left.mtl"></a-asset-item>
            <a-asset-item id="right-controller-obj" src="assets/controllers/right.obj"></a-asset-item>
            <a-asset-item id="right-controller-mtl" src="assets/controllers/right.mtl"></a-asset-item>

            <a-entity obj-model="obj: #raccoon-obj; mtl: #raccoon-mtl" scale="5 5 5"></a-entity>
            </a-entity>
          </a-entity>
        </template>

        <!-- Hand -->
        <template id="hand-template">
          <a-entity>
            <a-entity obj-model="obj: #left-controller-obj; mtl: #left-controller-mtl"></a-entity>
            </a-entity>
          </a-entity>
        </template>

        <!-- /Templates -->
      </a-assets>

      <a-entity id="player" enter_sphere kinematic-body-hover movement-controls="speed: 0.1" position="0 1 0" rotation="0 0 0"  networked="template:#player-template;attachTemplateToLocal:false;" spawn-in-circle="radius:3">
        <a-camera id="camera" wasd-controls="speed: 0.1" look-controls cursor="rayOrigin: mouse" networked="template:#head-template;attachTemplateToLocal:false;">
            <a-sphere class="head"
              random-color
              visible="false"
            ></a-sphere>
            <a-sky id='transition_sphere' src="#black" radius=".1"  visible='false' animation__fadein="startEvents: fadein; property: material.opacity; from: 0; to: 1; dur: 500;"
         animation__fadeout="startEvents: fadeout; property: material.opacity; from: 1; to: 0; dur: 500;"></a-sky>
        </a-camera>

        <!-- <a-entity rotation="-7.105 74.714 0" position="0 1 0" hand-controls="left" networked="template:#hand-template;" ></a-entity> -->
        <!-- <a-entity rotation="-7.105 74.714 0" position="0 1 0" hand-controls="right" networked="template:#hand-template;"></a-entity> -->
        <a-entity id="left_hand"
                  if-no-vr-headset="visible: false" 
                  rotation="-7.105 74.714 0" 
                  position="0 1.4 0" 
                  hand-controls="left" 
                  obj-model="obj: #left-controller-obj; mtl: #left-controller-mtl"
                  networked="template:#hand-template;" ></a-entity>

        <a-entity id="right_hand"
                  if-no-vr-headset="visible: false" 
                  rotation="-7.105 74.714 0" 
                  position="0 1.4 0" 
                  hand-controls="right" 
                  laser-controls="hand: right" 
                  obj-model="obj: #right-controller-obj; mtl: #right-controller-mtl"
                  networked="template:#hand-template;"></a-entity>
      </a-entity>

      <!-- Use the right controller to raise up and down in altitude -->

      <a-entity light="intensity:5;color:#222;type:ambient"></a-entity>

      <!-- Ground -->
      <!-- we've made the ground at height 2. Aweful but works for now -->
      <a-grid static-body material="visible:false;"></a-grid>

      <a-sky id='real_sky' src="#sky" rotation="0 -90 0"></a-sky>    
      <a-sky id='apt_sky' rotation='0 -90 0' visible='false' radius='25'></a-sky>     

      <!-- https://stackoverflow.com/questions/41336889/adding-new-entities-on-the-fly-in-aframe -->
      <a-entity id='photobeacons' position="0 0 0" visible='false'>
        <!-- spheres inserted here -->
      </a-entity>
      <a-entity id='vrbeacons' position="0 0 0">
        <!-- circles inserted here -->
      </a-entity>

    </a-scene>

    <script>
        // var sceneId = '9684c5e1-2459-4f60-9477-9f5a44e04370' 
        // var sceneId = 'e0500d95-0cc0-41b7-8ad2-fcc52d71e372' // vdc
        var sceneId = '2bbf2493-5c43-4ca3-93b5-88d9c94c0163'
        var scene = document.querySelector('a-scene')

        io3d.scene.getAframeElements(sceneId).then(function (elements) {
          elements
            .filter(function (elem) { return !elem.hasAttribute('camera') })
            .forEach(function (elem) {
              elem.setAttribute('rotation', '0 0 0')
              elem.setAttribute('position', '11.330 1 -.41')
              scene.appendChild(elem) 
            })
        })
    </script>

    <script>
      // add beacons for all images
      // photobeacons
      // for(var i=1; i<77; i++){
      //     var circle = document.createElement('a-circle');
      //     circle.setAttribute('id', i.toString());
      //     circle.setAttribute('position', photosHeadset[i.toString()][0] + ' 1.5 ' + photosHeadset[i.toString()][1]);
      //     circle.setAttribute('material', 'color: lightblue; transparent: true; opacity: 0.7');
      //     circle.setAttribute('radius', '.215');
      //     circle.setAttribute('rotation', "-90 0 0")
      //     var parent = document.getElementById("vrbeacons")
      //     parent.appendChild(circle);
      // }

      for(var i=1; i<77; i++){
          var sphere = document.createElement('a-sphere');
          var posx = photosHeadset[i.toString()][0];
          var posz= photosHeadset[i.toString()][1];
          sphere.setAttribute('id', i.toString());
          sphere.setAttribute('position', posx + ' 1.5 ' + posz);
          sphere.setAttribute('material', 'color: lightblue; transparent: true; opacity: 0.6');
          sphere.setAttribute('radius', '.15');
          sphere.setAttribute('bcn_teleport','');

          // teleport user to sphere on click [Check if VR device and make it work for that too]
          // sphere.addEventListener("click", (e)=>{
          //     var pos = document.querySelector("a-camera").getAttribute('position');
          //     pos.x = posx
          //     pos.z = posz
          //     document.querySelector("a-camera").setAttribute('position',pos)
          // });

          var parent = document.getElementById("vrbeacons")
          parent.appendChild(sphere);
          // alert(posx.toString() + " " + posz.toString())
      }

      for(var i=1; i<77; i++){
          var sphere = document.createElement('a-sphere');
          sphere.setAttribute('id', i.toString());
          sphere.setAttribute('position', photosHeadset[i.toString()][0] + ' 2.7 ' + photosHeadset[i.toString()][1]);
          sphere.setAttribute('material', 'color: lightblue; transparent: true; opacity: 0.3');
          sphere.setAttribute('radius', '.215');
          var parent = document.getElementById("photobeacons")
          parent.appendChild(sphere);
      }

      // add all images
      for(var i=1; i<77; i++){
          var image = document.createElement('img');
          image.setAttribute('id', i.toString());
          image.setAttribute('src', 'assets/360_pics/' + i.toString() + ".JPG");
          var parent = document.querySelector("a-assets")
          parent.appendChild(image);
      }      

    </script>

    <script>
      // Define custom schema for syncing avatar color, set by random-color
      NAF.schemas.add({
        template: '#head-template',
        components: [
          'position',
          'rotation',
          {
            selector: '.head',
            component: 'material'
          }
        ]
      });

      NAF.schemas.add({
        template: '#player-template',
        components: [
          'position',
          'rotation'
        ]
      });

      NAF.schemas.add({
        template: '#hand-template',
        components: [
          'position',
          'rotation'
        ]
      });

      // document.getElementById("spheres").setAttribute('position',document.getElementById("player").getAttribute('position').y - 2.7)

      // Called by Networked-Aframe when connected to server
      function onConnect () {
        console.log("onConnect", new Date());
      }

    </script>
    <script src="../js/vus_movement.js"></script>
  </body>
</html>
