<html style="background-color: black">
  <head>
    <meta charset="utf-8">
    <title>14 Octavus, Irvine, CA</title>
    <meta name="description" content="Dev Example â€” Networked-Aframe">

    <script src="../js/vr_group_session.js"></script>   
    <!-- <script src="../js/aframe.min.js"></script>  -->
    <script src="https://aframe.io/releases/0.7.1/aframe.min.js"></script>
    <script>window.NAF || document.write('<script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js">\x3C/script>')</script>
    <script src="https://unpkg.com/networked-aframe@^0.6.0/dist/networked-aframe.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.2.0/dist/aframe-physics-system.min.js"></script>
    <!-- <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v6.0.0/dist/aframe-extras.min.js"></script> -->
    <script src='../js/kinematic-body.js'></script>
    <script src="../js/movement-controls.js"></script>
    <script src="../js/touch-controls.js"></script>
    <script src="../js/trackpad-controls.js"></script>
    <script src='../js/kinematic-body.js'></script>
    <script src="//unpkg.com/aframe-animation-component@4.1.2/dist/aframe-animation-component.min.js"></script>
    <script src="https://dist.3d.io/3dio-js/1.1.x/3dio.min.js"></script>
    <script src="../js/vus_movement.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^4.0.0/dist/aframe-event-set-component.min.js"></script>

  </head>

  <body>
    <script>
      AFRAME.registerComponent('collider-check', {
        schema: {
            // store the name of the beacon its targeting to in an init variable
            base_level: {type: 'number', default: 1},
        },
        tick: function(){
            // DO THIS ONCE EVERY 0.5s ONLY
            var playerPos = document.getElementById("player").getAttribute("position")
            var cameraPos = document.querySelector("a-camera").getAttribute("position")
            this.el.object3D.position.x = playerPos.x + cameraPos.x
            this.el.object3D.position.z = playerPos.z + cameraPos.z
            this.el.object3D.position.y = playerPos.y + 1
        },
        init: function () {
          var base_level = this.data.base_level;
          this.current_level = base_level
          this.last_level_detected = 0
          this.same = 0
          setTimeout(function(){
              document.getElementsByClassName("io3d-level")[0].childNodes[0].className = 'floor'
              document.getElementsByClassName("io3d-scene")[0].addEventListener('raycaster-intersected', function (evt) {
                  var floor_level = evt.detail.intersection.point.y;

                  // filter out some noise. This is a temporory solution and won't work
                  // for two stories houses.
                  if (floor_level > 1.5){
                    return;
                  }
                  if(floor_level == this.last_level_detected){
                    this.same += 1
                  }
                  else{
                    this.same = 0
                  }
                  if(this.same > 1){
                      diff = floor_level - base_level
                      pos = document.getElementById("player").getAttribute("position")
                      pos.y = floor_level
                      document.getElementById("player").setAttribute("position", pos)
                      this.current_level = floor_level
                  }
                  this.last_level_detected = floor_level
              });
            },10000)

        }
      });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <a-scene antialias="true" physics="gravity:0;" beacons networked-scene="
      room: dev;
      debug: true;
      adapter: wseasyrtc;
      connectOnLoad: false;
      audio: true;
    ">
      <a-assets>
      
        <img id="sky" src="assets/sky.jpg" />
        <img id="black" src="assets/black.jpg" />

        <!-- Templates -->

        <!-- Avatar -->
        <template id="player-template">
          <a-entity></a-entity>
        </template>

        <!-- Avatar -->
        <template id="head-template">
          <a-entity class="avatar">
            <!-- <a-gltf-model id="head4" src="../assets/head_4/model.gltf"></a-gltf-model> -->

            <a-asset-item id="raccoon-obj" src="assets/Raccoon_Blocks/model.obj"></a-asset-item>
            <a-asset-item id="raccoon-mtl" src="assets/Raccoon_Blocks/materials.mtl"></a-asset-item>

            <a-asset-item id="left-controller-obj" src="assets/controllers/left.obj"></a-asset-item>
            <a-asset-item id="left-controller-mtl" src="assets/controllers/left.mtl"></a-asset-item>
            <a-asset-item id="right-controller-obj" src="assets/controllers/right.obj"></a-asset-item>
            <a-asset-item id="right-controller-mtl" src="assets/controllers/right.mtl"></a-asset-item>

            <a-entity obj-model="obj: #raccoon-obj; mtl: #raccoon-mtl" scale="5 5 5"></a-entity>
            </a-entity>
          </a-entity>
        </template>

        <!-- Hand -->
        <template id="hand-template">
          <a-entity>
            <a-entity obj-model="obj: #left-controller-obj; mtl: #left-controller-mtl"></a-entity>
            </a-entity>
          </a-entity>
        </template>

        <!-- /Templates -->
      </a-assets>

      <a-entity id="player" enter_sphere kinematic-body-hover movement-controls="speed: 0.1" position="0 1 0" rotation="0 0 0"  networked="template:#player-template;attachTemplateToLocal:false;" spawn-in-circle="radius:3">
        <a-camera id="camera" wasd-controls="speed: 0.1" look-controls cursor="rayOrigin: mouse" networked="template:#head-template;attachTemplateToLocal:false;">
            <a-sphere class="head"
              random-color
              visible="false"
            ></a-sphere>
            <a-sky id='transition_sphere' src="#black" radius=".1"  visible='false' animation__fadein="startEvents: fadein; property: material.opacity; from: 0; to: 1; dur: 500;"
         animation__fadeout="startEvents: fadeout; property: material.opacity; from: 1; to: 0; dur: 500;"></a-sky>
        </a-camera>

        <!-- Later, set objects to only the floor -->

        <!-- <a-entity rotation="-7.105 74.714 0" position="0 1 0" hand-controls="left" networked="template:#hand-template;" ></a-entity> -->
        <!-- <a-entity rotation="-7.105 74.714 0" position="0 1 0" hand-controls="right" networked="template:#hand-template;"></a-entity> -->
        <a-entity id="left_hand"
                  obj-model="obj: #left-controller-obj; mtl: #left-controller-mtl"
                  if-no-vr-headset="visible: false" 
                  rotation="-7.105 74.714 0" 
                  position="0 1.4 0" 
                  hand-controls="left" 
                  networked="template:#hand-template;"></a-entity>

        <a-entity id="right_hand"
                  obj-model="obj: #right-controller-obj; mtl: #right-controller-mtl"
                  if-no-vr-headset="visible: false" 
                  rotation="-7.105 74.714 0" 
                  position="0 1.4 0" 
                  hand-controls="right" 
                  laser-controls="hand: right" 
                  networked="template:#hand-template;"
                  raycaster="far: 10"
                  line="color: line; opacity: 1"></a-entity>
                  <!-- raycaster="objects: io3d-data3d; far: 10" -->
      </a-entity>

      <!-- <a-entity raycaster="showLine: true; far: 2; interval: 150;" rotation="-90 0 0" position="0 1.5 0" line="color: red; opacity: 1"></a-entity> -->

      <!-- Use the right controller to raise up and down in altitude -->

      <a-entity light="intensity:5;color:#222;type:ambient"></a-entity>

      <!-- Ground -->
      <!-- we've made the ground at height 2. Aweful but works for now -->
      <a-grid static-body material="visible:false;"></a-grid>

      <a-sky id='real_sky' src="#sky" rotation="0 -90 0"></a-sky>    
      <a-sky id='apt_sky' rotation='0 -90 0' visible='false' radius='25'></a-sky>  

      <a-entity id='vrbeacons' position="0 0 0">
        <!-- circles inserted here -->
      </a-entity>

    </a-scene>

    <script>
        // var sceneId = '9684c5e1-2459-4f60-9477-9f5a44e04370' 
        // var sceneId = 'e0500d95-0cc0-41b7-8ad2-fcc52d71e372' // vdc
        var sceneId = '2bbf2493-5c43-4ca3-93b5-88d9c94c0163'
        var scene = document.querySelector('a-scene')

        io3d.scene.getAframeElements(sceneId).then(function (elements) {
          elements
            .filter(function (elem) { return !elem.hasAttribute('camera') })
            .forEach(function (elem) {
              elem.setAttribute('rotation', '0 0 0')
              elem.setAttribute('position', '11.330 1 -.41')
              scene.appendChild(elem) 
            })
        })

        // give the base model an id

    </script>

    <script>

      function changeBcnColor(bcn_id){
          document.getElementById(bcn_id + "_bcn").setAttribute('material', 'color: lightblue; transparent: true; opacity: 0.8');  
      }

      // add all images
      for(var i=1; i<79; i++){
          var image360 = document.createElement('img');
          image360.setAttribute('id', i.toString());
          image360.setAttribute('src', 'assets/360_compressed/' + i.toString() + ".JPG");
          image360.setAttribute('onload', "changeBcnColor('" + i.toString() + "')");

          var parent = document.querySelector("a-assets")
          parent.appendChild(image360);
      }      

    </script>

    <script>
      // Define custom schema for syncing avatar color, set by random-color
      NAF.schemas.add({
        template: '#head-template',
        components: [
          'position',
          'rotation',
          {
            selector: '.head',
            component: 'material'
          }
        ]
      });

      NAF.schemas.add({
        template: '#player-template',
        components: [
          'position',
          'rotation'
        ]
      });

      NAF.schemas.add({
        template: '#hand-template',
        components: [
          'position',
          'rotation'
        ]
      });

      // document.getElementById("spheres").setAttribute('position',document.getElementById("player").getAttribute('position').y - 2.7)

      // Called by Networked-Aframe when connected to server
      function onConnect () {
        console.log("onConnect", new Date());
      }

    </script>
    <script src="../js/vus_movement.js"></script>
  </body>
</html>
