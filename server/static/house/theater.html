<html style="background-color: black">
  <head>
    <meta charset="utf-8">
    <title>Dev Example — Networked-Aframe</title>
    <meta name="description" content="Dev Example — Networked-Aframe">

    <script src="../vr_group_session.js"></script>   
    <script src="../aframe.min.js"></script> 
    <script src="../build.js"></script>
    <script>window.NAF || document.write('<script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js">\x3C/script>')</script>
    <!-- <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script> -->
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.2.0/dist/aframe-physics-system.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v6.0.0/dist/aframe-extras.min.js"></script>
    <script src='../kinematic-body.js'></script>

    <script src="video-transport.js"></script>
    <script>
      var singletonSchema = {
        template: '#singleton-template',
        components: [
          'position',
          'rotation',          
/*          
          // This won't work when the video is referenced by selector!
          // And some videos won't work this way regardless, due to CORS
          // (What happened to the automatic video element creation code?)
          {
            selector: '.front',
            component: 'material',
            property: 'src'
          },
*/        
          // This works but needs care when syncing, to avoid continual resync.
          {
            selector: '.front',
            component: 'video-transport',
            property: 'currentTime'
          },
          
          // There may be an order of operations race condition to prevent,
          // when restarting the position needs to be reset before play,
          // or else the play will fail due to the end position.
          {
            selector: '.front',
            component: 'video-transport',
            property: 'paused'
          }
        ]
      };
    </script>

  </head>

  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <a-scene physics="gravity:0;"  networked-scene="
      room: dev;
      debug: true;
      adapter: wseasyrtc;
      connectOnLoad: false;
      audio: true;
    ">
      <a-assets>

        <video id="video" 
               src="//edge.flowplayer.org/functional.mp4"
               notsrc="https://videos.littlstar.com/7b5d6018-4cd6-466b-bf8b-79134d062147/web.mp4"
               crossorigin="anonymous" autoplay playsinline="playsinline" loop></video>

        <template id="singleton-template" >
          <a-entity class="singleton" position="4.981 3.763 0.992" networked="template:#singleton-template;networkId:singleton;owner:eGJE2vsylBxQTq2m" rotation="0 270 0" scale="3.791 3.008 1">
              <a-video video-transport="paused:true" class="front" material="side:front" src="#video"></a-video>
              <a-plane class="back" rotation="0 180 0" material="color:red" text="align:center;value:Hi back;wrapCount:8"></a-plane>
          </a-entity>
        </template>



        <!-- Templates -->

        <!-- Avatar -->
        <template id="avatar-template">
          <a-entity class="avatar">

            <a-asset-item id="raccoon-obj" src="../assets/Raccoon_Blocks/model.obj"></a-asset-item>
            <a-asset-item id="raccoon-mtl" src="../assets/Raccoon_Blocks/materials.mtl"></a-asset-item>

            <a-asset-item id="scene-obj" src="../assets/Campfire_Blocks/model.obj"></a-asset-item>
            <a-asset-item id="scene-mtl" src="../assets/Campfire_Blocks/materials.mtl"></a-asset-item>
            <a-entity obj-model="obj: #raccoon-obj; mtl: #raccoon-mtl" scale="5 5 5"></a-entity>

            </a-entity>
          </a-entity>
        </template>

        <!-- /Templates -->
      </a-assets>

      <a-entity id="player" rotation="0 0 0" position="0 1.6 0" networked="template:#avatar-template;attachTemplateToLocal:false;" camera="userHeight: 1.6" networked-audio-source spawn-in-circle="radius:3" wasd-controls="acceleration: 1" look-controls>
        <a-sphere class="head"
          visible="false"
          random-color
        ></a-sphere>
      </a-entity>

      <a-entity class="singleton" position="0 1.6 -1" 
                networked="template:#singleton-template;networkId:singleton;owner:nobody">
      </a-entity>   

      <a-gltf-model id="apt-mtl" scale="5 5 5" src="../assets/theater_2/model.gltf" position="0 -5.598 0" gltf-model="../assets/theater_2/model.gltf"></a-gltf-model>

      <a-entity light="color:#222;intensity:1.12;type:ambient"></a-entity>
      <a-entity light="intensity:5.34;type:point;groundColor:#ffdbc0;decay:0.9;color:#222" position="4.964 3.837 0.824" rotation="0.40107045659157625 129.83223637664454 3.036676314193363"></a-entity>
    

      <a-camera kinematic-body-hover rotation="-2.636 -111.612 0" position="0 1.6 0"> 
        <a-entity cursor="fuse: false"  position="0 0 -1"   geometry="primitive:ring; radiusInner: 0.02; radiusOuter: 0.03"  material="color: black; shader: flat"></a-ring>
      </a-camera>

    </a-scene>

    <script>
        host = "http://127.0.0.1"
        // host = "http://192.168.0.128"

    </script>

    <script>
      // Define custom schema for syncing avatar color, set by random-color
      NAF.schemas.add({
        template: '#avatar-template',
        components: [
          'position',
          'rotation',
          {
            selector: '.head',
            component: 'material',
            property: 'color'
          }
        ]
      });

      NAF.schemas.add(singletonSchema);
 

      function onConnect () {
        // The first client is the NOT only one that sees no other clients after connection,
        // so it is NOT safe to take ownership of singletons immediately upon onConnect.
        // We'll listen for a certain period, and if no client connections, take ownership.
        // FIXME: How to determine the timeout?  Race condition.
                
        console.warn('onConnect() ', new Date());
        
        // Set up the lone ownership timeout.
        var lonerTimeout = setTimeout(function() {
          // This would be more useful if there were multiple singletons in the example.
          Array.prototype.slice.call(document.querySelectorAll('.singleton[networked]'))
            .map(function (el) {
              // Take ownership.
              el.setAttribute('networked', 'owner', NAF.clientId);
              console.warn('Took ownership as ', NAF.clientId, ' of ', el);
            });
        }, 500);
        
        document.body.addEventListener('clientConnected', function (evt) {
          console.warn('clientConnected ', evt.detail.clientId);          
          // Cancel the lone ownership timeout.
          clearTimeout(lonerTimeout);
        });
        
        document.body.addEventListener('clientDisconnected', function (evt) {
          console.warn('clientDisconnected ', evt.detail.clientId);
        });
      }

    </script>
  </body>
</html>
